<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>
      Deploy Rails with PostgreSQL Using Passenger and Nginx on CentOS |
      å­™è€€ç çš„åšå®¢
    </title>

    <meta charset="utf-8" />
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />
    <meta
      name="google-site-verification"
      content="zYt2wigM41vmyHtpvOvLHk4Yetcfbv5Bz9pdvsTRT3Y"
    />

    <!-- Begin Jekyll SEO tag v2.7.1 -->
    <meta name="generator" content="Jekyll v4.2.0" />
    <meta
      property="og:title"
      content="Deploy Rails with PostgreSQL Using Passenger and Nginx on CentOS"
    />
    <meta name="author" content="å­™è€€ç " />
    <meta property="og:locale" content="en_US" />
    <meta
      name="description"
      content="æœ€è¿‘è¯»å®Œäº† Michael Hartl çš„ã€ŠRuby on Rails Tutorialã€‹ï¼Œäºæ˜¯æƒ³è¯•ç€åœ¨è‡ªå·±çš„ Digital Ocean (CentOS 7) ä¸Šéƒ¨ç½²ä¸€ä¸‹æœ€ç»ˆå®Œæˆçš„ sample appã€‚æœ€ç®€å•çš„æ–¹æ³•å½“ç„¶æ˜¯ï¼š $ rails server -e production -b 0.0.0.0 -p 80 ä½† Rails å†…å»ºçš„ WEBrick + SQLite æ€§èƒ½è¾ƒå·®ï¼Œè€Œä¸”è¿™æ ·éƒ¨ç½²ä¹Ÿä¸å¤Ÿçµæ´»ï¼Œè¿˜æ˜¯ä¸Š Apache / Nginx æ¯”è¾ƒä¸»æµã€‚ä¸ Apache ç›¸æ¯” Nginx çš„å¼‚æ­¥æ¨¡å‹èƒ½æ›´å¥½åœ°å¤„ç†é«˜å¹¶å‘çš„åœºæ™¯ï¼ŒPassenger æ€§èƒ½ä¸é”™å¹¶ä¸”å¯ä»¥ç›´æ¥é›†æˆäº Apache / Nginx è€Œä¸å¿…åå‘ä»£ç†ï¼Œè€Œ PostgreSQL æ¯” MySQL / MariaDB åŠŸèƒ½æ›´å¼ºå¤§ï¼Œè¿™ä¸‰è€…æ˜¯ Ruby æœåŠ¡å™¨çš„æœ€ä½³å®è·µä¹‹ä¸€ï¼Œå› æ­¤æˆ‘å†³å®šæŠ˜è…¾ä¸€ä¸‹ Nginx + Passenger + PostgreSQLã€‚"
    />
    <meta
      property="og:description"
      content="æœ€è¿‘è¯»å®Œäº† Michael Hartl çš„ã€ŠRuby on Rails Tutorialã€‹ï¼Œäºæ˜¯æƒ³è¯•ç€åœ¨è‡ªå·±çš„ Digital Ocean (CentOS 7) ä¸Šéƒ¨ç½²ä¸€ä¸‹æœ€ç»ˆå®Œæˆçš„ sample appã€‚æœ€ç®€å•çš„æ–¹æ³•å½“ç„¶æ˜¯ï¼š $ rails server -e production -b 0.0.0.0 -p 80 ä½† Rails å†…å»ºçš„ WEBrick + SQLite æ€§èƒ½è¾ƒå·®ï¼Œè€Œä¸”è¿™æ ·éƒ¨ç½²ä¹Ÿä¸å¤Ÿçµæ´»ï¼Œè¿˜æ˜¯ä¸Š Apache / Nginx æ¯”è¾ƒä¸»æµã€‚ä¸ Apache ç›¸æ¯” Nginx çš„å¼‚æ­¥æ¨¡å‹èƒ½æ›´å¥½åœ°å¤„ç†é«˜å¹¶å‘çš„åœºæ™¯ï¼ŒPassenger æ€§èƒ½ä¸é”™å¹¶ä¸”å¯ä»¥ç›´æ¥é›†æˆäº Apache / Nginx è€Œä¸å¿…åå‘ä»£ç†ï¼Œè€Œ PostgreSQL æ¯” MySQL / MariaDB åŠŸèƒ½æ›´å¼ºå¤§ï¼Œè¿™ä¸‰è€…æ˜¯ Ruby æœåŠ¡å™¨çš„æœ€ä½³å®è·µä¹‹ä¸€ï¼Œå› æ­¤æˆ‘å†³å®šæŠ˜è…¾ä¸€ä¸‹ Nginx + Passenger + PostgreSQLã€‚"
    />
    <link rel="canonical" href="https://blog.yzsun.me/rails-deployment/" />
    <meta property="og:url" content="https://blog.yzsun.me/rails-deployment/" />
    <meta property="og:site_name" content="å­™è€€ç çš„åšå®¢" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2016-02-10T00:00:00+00:00"
    />
    <meta name="twitter:card" content="summary" />
    <meta
      property="twitter:title"
      content="Deploy Rails with PostgreSQL Using Passenger and Nginx on CentOS"
    />
    <script type="application/ld+json">
      {
        "description": "æœ€è¿‘è¯»å®Œäº† Michael Hartl çš„ã€ŠRuby on Rails Tutorialã€‹ï¼Œäºæ˜¯æƒ³è¯•ç€åœ¨è‡ªå·±çš„ Digital Ocean (CentOS 7) ä¸Šéƒ¨ç½²ä¸€ä¸‹æœ€ç»ˆå®Œæˆçš„ sample appã€‚æœ€ç®€å•çš„æ–¹æ³•å½“ç„¶æ˜¯ï¼š $ rails server -e production -b 0.0.0.0 -p 80 ä½† Rails å†…å»ºçš„ WEBrick + SQLite æ€§èƒ½è¾ƒå·®ï¼Œè€Œä¸”è¿™æ ·éƒ¨ç½²ä¹Ÿä¸å¤Ÿçµæ´»ï¼Œè¿˜æ˜¯ä¸Š Apache / Nginx æ¯”è¾ƒä¸»æµã€‚ä¸ Apache ç›¸æ¯” Nginx çš„å¼‚æ­¥æ¨¡å‹èƒ½æ›´å¥½åœ°å¤„ç†é«˜å¹¶å‘çš„åœºæ™¯ï¼ŒPassenger æ€§èƒ½ä¸é”™å¹¶ä¸”å¯ä»¥ç›´æ¥é›†æˆäº Apache / Nginx è€Œä¸å¿…åå‘ä»£ç†ï¼Œè€Œ PostgreSQL æ¯” MySQL / MariaDB åŠŸèƒ½æ›´å¼ºå¤§ï¼Œè¿™ä¸‰è€…æ˜¯ Ruby æœåŠ¡å™¨çš„æœ€ä½³å®è·µä¹‹ä¸€ï¼Œå› æ­¤æˆ‘å†³å®šæŠ˜è…¾ä¸€ä¸‹ Nginx + Passenger + PostgreSQLã€‚",
        "url": "https://blog.yzsun.me/rails-deployment/",
        "@type": "BlogPosting",
        "headline": "Deploy Rails with PostgreSQL Using Passenger and Nginx on CentOS",
        "dateModified": "2016-02-10T00:00:00+00:00",
        "datePublished": "2016-02-10T00:00:00+00:00",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://blog.yzsun.me/rails-deployment/"
        },
        "author": { "@type": "Person", "name": "å­™è€€ç " },
        "@context": "https://schema.org"
      }
    </script>
    <!-- End Jekyll SEO tag -->

    <link
      type="application/atom+xml"
      rel="alternate"
      href="https://blog.yzsun.me/feed.xml"
      title="å­™è€€ç çš„åšå®¢"
    />

    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/r29/html5.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="/style.css" />
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"
            ><img src="/images/avatar.jpg" alt="avatar"
          /></a>

          <div class="site-info">
            <h1 class="site-domain"><a href="/">yzsun.me</a></h1>
            <p class="site-name">å­™è€€ç çš„åšå®¢</p>
          </div>

          <nav>
            <a href="/">é¦–é¡µ</a>
            <a href="/archive/">å½’æ¡£</a>
            <a href="/about/">å…³äº</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
        <h1>
          Deploy Rails with PostgreSQL Using Passenger and Nginx on CentOS
        </h1>

        <div class="info">
          <span>
            <i class="fa fa-calendar"></i>
            2016-02-10
          </span>
          <span>
            <i class="fa fa-user"></i>
            å­™è€€ç 
          </span>
          <span>
            <i class="fa fa-tags"></i>
            è¿ç»´
          </span>
        </div>

        <div class="entry">
          <p>
            æœ€è¿‘è¯»å®Œäº† Michael Hartl çš„ã€ŠRuby on Rails
            Tutorialã€‹ï¼Œäºæ˜¯æƒ³è¯•ç€åœ¨è‡ªå·±çš„ Digital Ocean (CentOS 7)
            ä¸Šéƒ¨ç½²ä¸€ä¸‹æœ€ç»ˆå®Œæˆçš„ sample appã€‚æœ€ç®€å•çš„æ–¹æ³•å½“ç„¶æ˜¯ï¼š
          </p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span>rails server <span class="nt">-e</span> production <span class="nt">-b</span> 0.0.0.0 <span class="nt">-p</span> 80
</code></pre>
            </div>
          </div>

          <p>
            ä½† Rails å†…å»ºçš„ WEBrick + SQLite
            æ€§èƒ½è¾ƒå·®ï¼Œè€Œä¸”è¿™æ ·éƒ¨ç½²ä¹Ÿä¸å¤Ÿçµæ´»ï¼Œè¿˜æ˜¯ä¸Š Apache / Nginx æ¯”è¾ƒä¸»æµã€‚ä¸
            Apache ç›¸æ¯” Nginx çš„å¼‚æ­¥æ¨¡å‹èƒ½æ›´å¥½åœ°å¤„ç†é«˜å¹¶å‘çš„åœºæ™¯ï¼ŒPassenger
            æ€§èƒ½ä¸é”™å¹¶ä¸”å¯ä»¥ç›´æ¥é›†æˆäº Apache / Nginx è€Œä¸å¿…åå‘ä»£ç†ï¼Œè€Œ
            PostgreSQL æ¯” MySQL / MariaDB åŠŸèƒ½æ›´å¼ºå¤§ï¼Œè¿™ä¸‰è€…æ˜¯ Ruby
            æœåŠ¡å™¨çš„æœ€ä½³å®è·µä¹‹ä¸€ï¼Œå› æ­¤æˆ‘å†³å®šæŠ˜è…¾ä¸€ä¸‹ Nginx + Passenger +
            PostgreSQLã€‚
          </p>

          <!--more-->

          <ul id="markdown-toc">
            <li>
              <a href="#å®‰è£…-ruby" id="markdown-toc-å®‰è£…-ruby">å®‰è£… Ruby</a>
            </li>
            <li>
              <a
                href="#å®‰è£…-javascript-å¼•æ“"
                id="markdown-toc-å®‰è£…-javascript-å¼•æ“"
                >å®‰è£… JavaScript å¼•æ“</a
              >
            </li>
            <li>
              <a
                href="#å®‰è£…-nginx--passenger"
                id="markdown-toc-å®‰è£…-nginx--passenger"
                >å®‰è£… Nginx + Passenger</a
              >
            </li>
            <li>
              <a href="#å®‰è£…-postgresql" id="markdown-toc-å®‰è£…-postgresql"
                >å®‰è£… PostgreSQL</a
              >
            </li>
            <li>
              <a href="#éƒ¨ç½²-rails" id="markdown-toc-éƒ¨ç½²-rails">éƒ¨ç½² Rails</a>
            </li>
            <li>
              <a href="#å¯åŠ¨-nginx" id="markdown-toc-å¯åŠ¨-nginx">å¯åŠ¨ Nginx</a>
            </li>
            <li><a href="#å¸¸è§é—®é¢˜" id="markdown-toc-å¸¸è§é—®é¢˜">å¸¸è§é—®é¢˜</a></li>
            <li><a href="#æµ‹è¯•ç¯å¢ƒ" id="markdown-toc-æµ‹è¯•ç¯å¢ƒ">æµ‹è¯•ç¯å¢ƒ</a></li>
          </ul>

          <h2 id="å®‰è£…-ruby">å®‰è£… Ruby</h2>

          <p>
            ç›´æ¥ä½¿ç”¨ yum å®‰è£…å½“ç„¶æ˜¯å¯è¡Œçš„ï¼Œä½†
            <a href="https://rvm.io">Ruby Version Manager (RVM)</a>
            èƒ½å¤Ÿæ›´æ–¹ä¾¿åœ°å®‰è£…å¹¶ç®¡ç† Ruby ç‰ˆæœ¬ï¼Œå› æ­¤ä¸‹é¢ä»¥ RVM ä¸ºä¾‹ã€‚å®‰è£… RVMï¼š
          </p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span>gpg <span class="nt">--recv-keys</span> 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
<span class="nv">$ </span>curl <span class="nt">-sSL</span> https://get.rvm.io | bash <span class="nt">-s</span> stable
</code></pre>
            </div>
          </div>

          <p>
            æ¥ç€å°±èƒ½è½»æ¾åœ°å®‰è£…ä»»æ„ç‰ˆæœ¬çš„ Ruby äº†ï¼ˆ<code
              class="language-plaintext highlighter-rouge"
              >rvm list known</code
            >
            å¯ä»¥åˆ—å‡ºå·²çŸ¥çš„ç‰ˆæœ¬ï¼‰ï¼š
          </p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span>rvm <span class="nb">install </span>X.X.X
<span class="nv">$ </span>rvm <span class="nt">--default</span> use X.X.X
</code></pre>
            </div>
          </div>

          <p>
            ä¸ºäº†ç®¡ç†é¡¹ç›®ä¾èµ–ï¼Œè¿˜éœ€è¦å®‰è£…ä¸€ä¸‹
            <a href="http://bundler.io">Bundler</a>ï¼š
          </p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span>gem <span class="nb">install </span>bundler <span class="nt">--no-rdoc</span> <span class="nt">--no-ri</span>
</code></pre>
            </div>
          </div>

          <p>
            å¦‚æœæœåŠ¡å™¨åœ¨å›½å†…ï¼Œç”±äºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œä¹Ÿè®¸ä¼šé¢‘ç¹é­é‡ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¿™æ—¶å€™å¯ä»¥è€ƒè™‘ä½¿ç”¨
            Ruby China çš„
            <a href="https://ruby-china.org/wiki/ruby-mirror"
              >Ruby æºä»£ç é•œåƒ</a
            >
            å’Œ <a href="https://gems.ruby-china.org">RubyGems é•œåƒ</a>ï¼š
          </p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"ruby_url=https://cache.ruby-china.org/pub/ruby"</span> <span class="o">&gt;</span> <span class="nv">$rvm_path</span>/user/db
<span class="nv">$ </span>gem sources <span class="nt">-a</span> https://gems.ruby-china.org/ <span class="nt">-r</span> https://rubygems.org/
<span class="nv">$ </span>bundle config mirror.https://rubygems.org https://gems.ruby-china.org
</code></pre>
            </div>
          </div>

          <h2 id="å®‰è£…-javascript-å¼•æ“">å®‰è£… JavaScript å¼•æ“</h2>

          <p>
            å¦‚æœ Gemfile ç›´æ¥æˆ–é—´æ¥ä¾èµ–äº†
            <a href="https://github.com/rails/execjs">ExecJS</a>ï¼Œè­¬å¦‚
            <code class="language-plaintext highlighter-rouge"
              >coffee-rails</code
            >
            /
            <code class="language-plaintext highlighter-rouge">turbolinks</code>
            /
            <code class="language-plaintext highlighter-rouge">uglifier</code> /
            <code class="language-plaintext highlighter-rouge"
              >bootstrap-sass</code
            >
            ç­‰ç­‰ï¼Œåˆ™è¿˜éœ€è¦å®‰è£… JS å¼•æ“ï¼Œä»¥åœ¨ Ruby ä¸­æ‰§è¡Œ JS ä»£ç ã€‚
          </p>

          <ul>
            <li>
              ä¸€ç§æ–¹æ³•æ˜¯åœ¨ Gemfile ä¸­åŠ ä¸Š
              <code class="language-plaintext highlighter-rouge"
                >gem 'therubyracer'</code
              >ï¼Œè¿™æ˜¯ä¸€ä¸ªåµŒå…¥å¼çš„ V8 å¼•æ“ã€‚
            </li>
            <li>
              å¦ä¸€ç§æ–¹æ³•æ˜¯ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šå®‰è£… Node.jsï¼Œè¿™ä½¿ç”¨çš„ä¹Ÿæ˜¯ V8 å¼•æ“ã€‚å®‰è£…
              <a href="https://fedoraproject.org/wiki/EPEL/zh-cn"
                >Extra Packages for Enterprise Linux (EPEL)</a
              >
              åå¯ä»¥ç›´æ¥é€šè¿‡ yum å®‰è£… nodeï¼Œä½†ç‰ˆæœ¬ä¼šæ¯”è¾ƒæ—§ï¼›ä¸ RVM ç±»ä¼¼ï¼ŒNode.js
              ä¹Ÿæœ‰
              <a href="https://github.com/creationix/nvm">NVM</a>
              æ¥å®‰è£…å’Œç®¡ç†ç‰ˆæœ¬ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚
            </li>
          </ul>

          <h2 id="å®‰è£…-nginx--passenger">å®‰è£… Nginx + Passenger</h2>

          <p>
            yum åŸæœ¬çš„æºä¸­æ²¡æœ‰ Nginx å’Œ Passengerï¼Œå¯ä»¥å¯¼å…¥
            <a
              href="https://www.phusionpassenger.com/library/install/nginx/install/oss/el7/"
              >Passenger è‡ªå·±çš„æº</a
            >ï¼Œå®‰è£…å·²åŒ…å« Passenger æ¨¡å—çš„ Nginx ç‰ˆæœ¬ï¼ˆè¿™æ ·å°±ä¸å¿…å»è¿è¡Œ
            <code class="language-plaintext highlighter-rouge"
              >passenger-install-nginx-module</code
            >
            äº†ï¼‰å’Œ Passenger æœ¬ä½“ï¼š
          </p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span>curl <span class="nt">--fail</span> <span class="nt">-sSLo</span> /etc/yum.repos.d/passenger.repo https://oss-binaries.phusionpassenger.com/yum/definitions/el-passenger.repo
<span class="nv">$ </span>yum <span class="nt">-y</span> <span class="nb">install </span>nginx passenger
</code></pre>
            </div>
          </div>

          <p>
            æ¥ç€åœ¨
            <code class="language-plaintext highlighter-rouge"
              >/etc/nginx/conf.d/passenger.conf</code
            >
            ä¸­è§£é™¤ä¸‹é¢ä¸‰è¡Œçš„æ³¨é‡Šï¼š
          </p>

          <div class="language-nginx highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="k">passenger_root</span> <span class="n">/usr/share/ruby/vendor_ruby/phusion_passenger/locations.ini</span><span class="p">;</span>
<span class="k">passenger_ruby</span> <span class="n">/usr/bin/ruby</span><span class="p">;</span>
<span class="k">passenger_instance_registry_dir</span> <span class="n">/var/run/passenger-instreg</span><span class="p">;</span>
</code></pre>
            </div>
          </div>

          <h2 id="å®‰è£…-postgresql">å®‰è£… PostgreSQL</h2>

          <p>å…ˆä» yum å®‰è£… PostgreSQLï¼š</p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span>yum <span class="nt">-y</span> <span class="nb">install </span>postgresql-server postgresql-devel
<span class="nv">$ </span>postgresql-setup initdb
</code></pre>
            </div>
          </div>

          <p>
            æ¥ç€ç”¨
            <a href="https://fedoraproject.org/wiki/Systemd/zh-cn">systemd</a
            >ï¼ˆåœ¨ CentOS 7 ä¸­å®ƒå–ä»£äº† Upstart å’Œ
            SysVinitï¼‰å¯åŠ¨æ•°æ®åº“å¹¶è®¾ä¸ºå¼€æœºå¯åŠ¨é¡¹ï¼š
          </p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span>systemctl start postgresql
<span class="nv">$ </span>systemctl <span class="nb">enable </span>postgresql
</code></pre>
            </div>
          </div>

          <p>
            PostgreSQL é»˜è®¤çš„è¶…çº§ç”¨æˆ·æ˜¯
            <code class="language-plaintext highlighter-rouge">postgres</code
            >ï¼Œä½¿ç”¨åŒåçš„æ“ä½œç³»ç»Ÿè´¦æˆ·å¯ä»¥ç›´æ¥ç™»å½•ï¼Œè¿™é‡Œä¸ºæ•°æ®åº“æ–°å»ºä¸€ä¸ªç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·<strong
              >åº”ä¸åæ–‡çš„ Linux ç”¨æˆ·åŒå</strong
            >ä»¥ä¾¿å…å¯†ç è¿æ¥æ•°æ®åº“ï¼š
          </p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span>su - postgres
<span class="nv">$ </span>createuser sample-app
<span class="nv">$ </span>createdb <span class="nt">-O</span> sample-app sample-app
</code></pre>
            </div>
          </div>

          <p>Gemfile ä¸­ä¹Ÿéœ€è¦åŠ å…¥ PostgreSQL çš„æ¥å£ï¼š</p>

          <div class="language-ruby highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="n">gem</span> <span class="s1">'pg'</span><span class="p">,</span> <span class="ss">group: :production</span>
</code></pre>
            </div>
          </div>

          <p>
            å¦‚æœåˆ›å»º app çš„æ—¶å€™æ²¡æœ‰æŒ‡å®šæ•°æ®åº“ï¼ˆè­¬å¦‚
            <code class="language-plaintext highlighter-rouge"
              >rails new sample-app -d postgresql</code
            >ï¼‰ï¼Œé‚£ä¹ˆ Rails é»˜è®¤ä½¿ç”¨çš„æ˜¯ SQLite 3ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æå‰ä¿®æ”¹ä¸€ä¸‹ Rails
            çš„é…ç½®æ–‡ä»¶
            <code class="language-plaintext highlighter-rouge"
              >config/database.yml</code
            >ï¼š
          </p>

          <div class="language-yaml highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="na">production</span><span class="pi">:</span>
  <span class="na">adapter</span><span class="pi">:</span> <span class="s">postgresql</span>
  <span class="na">encoding</span><span class="pi">:</span> <span class="s">unicode</span>
  <span class="na">pool</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">sample-app</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">sample-app</span>
</code></pre>
            </div>
          </div>

          <h2 id="éƒ¨ç½²-rails">éƒ¨ç½² Rails</h2>

          <p>
            ä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œæœ€å¥½ä¸ºæ¯ä¸ª app åˆ›å»ºä¸€ä¸ªåŒåçš„ Linux ç”¨æˆ·ï¼ŒPassenger
            ä¹Ÿæä¾›äº†ç›¸åº”çš„<a
              href="https://www.phusionpassenger.com/library/deploy/nginx/user_sandboxing.html"
              >ç”¨æˆ·è´¦æˆ·æ²™ç›’</a
            >åŠŸèƒ½ï¼Œé»˜è®¤ä¼šä»¥
            <code class="language-plaintext highlighter-rouge">config.ru</code>
            çš„æ‰€æœ‰è€…è¿è¡Œ appã€‚ä¸‹é¢çš„éƒ¨ç½²å·¥ä½œéƒ½åœ¨è¯¥è´¦æˆ·ä¸‹å®Œæˆï¼ˆä»¥ä¸‹å‡è®¾ app åœ¨
            <code class="language-plaintext highlighter-rouge"
              >/srv/sample-app</code
            >ï¼‰ï¼š
          </p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span>adduser sample-app
<span class="nv">$ </span><span class="nb">chown</span> <span class="nt">-R</span> sample-app: /srv/sample-app
<span class="nv">$ </span>su - sample-app
</code></pre>
            </div>
          </div>

          <p>
            é¦–å…ˆæ˜¯é€šè¿‡ Bundler å®‰è£… app çš„ä¾èµ–é¡¹ï¼Œå› ä¸ºæ˜¯éƒ¨ç½²æ¨¡å¼æ‰€ä»¥
            <code class="language-plaintext highlighter-rouge"
              >Gemfile.lock</code
            >
            åº”å½“æå‰å·²ç»ç”Ÿæˆå¥½ï¼š
          </p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span><span class="nb">cd</span> /srv/sample-app
<span class="nv">$ </span>bundle <span class="nb">install</span> <span class="nt">--deployment</span> <span class="nt">--without</span> development <span class="nb">test</span>
</code></pre>
            </div>
          </div>

          <p>
            æ¥ä¸‹æ¥æ£€æŸ¥ä¸€ä¸‹
            <code class="language-plaintext highlighter-rouge"
              >config/database.yml</code
            >
            å’Œ
            <code class="language-plaintext highlighter-rouge"
              >config/secrets.yml</code
            >ï¼Œå‰è€…å³ä¸Šæ–‡æåˆ°çš„æ•°æ®åº“é…ç½®ï¼Œåè€…å­˜å‚¨çš„æ˜¯ç”¨æ¥åŠ å¯† cookies
            çš„å¯†é’¥ï¼Œç”Ÿäº§ç¯å¢ƒé»˜è®¤ä»ç¯å¢ƒå˜é‡è¯»å–å¯†é’¥ï¼Œä»¥é˜²å¼€å‘è€…æ‰‹æ»‘å°†å…¶ä¸Šä¼ åˆ°
            public repoï¼š
          </p>

          <div class="language-yaml highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="c1"># Do not keep production secrets in the repository, instead read values from the environment.</span>
<span class="na">production</span><span class="pi">:</span>
  <span class="na">secret_key_base</span><span class="pi">:</span> <span class="s">&lt;%= ENV["SECRET_KEY_BASE"] %&gt;</span>
</code></pre>
            </div>
          </div>

          <p>
            å¯†é’¥å¯é€šè¿‡
            <code class="language-plaintext highlighter-rouge"
              >bundle exec rake secret</code
            >
            ç”Ÿæˆï¼Œè‡³äºå¦‚ä½•å†™å…¥ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š
          </p>

          <ul>
            <li>
              æŠŠ
              <code class="language-plaintext highlighter-rouge"
                >export SECRET_KEY_BASE=...</code
              >
              ç›´æ¥å†™è¿›
              <code class="language-plaintext highlighter-rouge"
                >~/.bashrc</code
              >
              æˆ–æ˜¯å…¶ä»– shell çš„å¯åŠ¨æ–‡ä»¶ï¼›
            </li>
            <li>
              åœ¨ Gemfile ä¸­åŠ å…¥
              <a href="https://github.com/bkeepers/dotenv">dotenv-rails</a
              >ï¼Œä½¿ç”¨
              <code class="language-plaintext highlighter-rouge"
                >.env.production</code
              >
              æ–‡ä»¶ç®¡ç†ç”Ÿäº§ç¯å¢ƒï¼›
            </li>
            <li>
              ä¸å°‘å¼€å‘è€…ä¼šä½¿ç”¨
              <a href="https://github.com/ddollar/foreman">Foreman</a>
              å¯åŠ¨å„ç§æœåŠ¡ï¼Œå®ƒä¼šè‡ªåŠ¨è¯»å–
              <code class="language-plaintext highlighter-rouge">.env</code>
              æ–‡ä»¶ï¼›
            </li>
            <li>
              åœ¨é›†æˆäº† Passenger çš„ Nginx é…ç½®æ–‡ä»¶ä¸­åŠ ä¸Š
              <code class="language-plaintext highlighter-rouge"
                >passenger_env_var SECRET_KEY_BASE ...</code
              >ã€‚
            </li>
          </ul>

          <p>
            å½“ç„¶å•å•åœ¨ shell é‡Œæ•²ä¸€è¡Œ export å‘½ä»¤æ˜¯ä¸è¡Œçš„ï¼Œè¿™åªä¼šåœ¨å½“å‰ shell
            åŠå…¶å­è¿›ç¨‹ä¸­ç”Ÿæ•ˆã€‚å¦å¤–<strong>ä¸è¦éšæ„æ›´æ”¹å¯†é’¥</strong>ï¼Œè¿™ä¼šä½¿åŸå…ˆåŠ å¯†çš„
            cookies å¤±æ•ˆã€‚
          </p>

          <p>
            æœ€åè®©
            <a href="http://guides.ruby-china.org/asset_pipeline.html"
              >Asset Pipeline</a
            >
            å¯¹é™æ€èµ„æºåšé¢„ç¼–è¯‘ï¼Œè®© Active Record
            åšæ•°æ®åº“è¿ç§»ï¼Œåˆ«å¿˜äº†<strong>æŒ‡å®šç”Ÿäº§ç¯å¢ƒ</strong>ï¼š
          </p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span>bundle <span class="nb">exec </span>rake assets:precompile db:migrate <span class="nv">RAILS_ENV</span><span class="o">=</span>production
</code></pre>
            </div>
          </div>

          <h2 id="å¯åŠ¨-nginx">å¯åŠ¨ Nginx</h2>

          <p>
            å›åˆ°ç®¡ç†å‘˜è´¦æˆ·ï¼Œåˆ›å»º Nginx é…ç½®æ–‡ä»¶
            <code class="language-plaintext highlighter-rouge"
              >/etc/nginx/conf.d/sample-app.conf</code
            >ï¼Œä¸ºè‡ªå·±çš„ app æ·»åŠ ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œå…¶ä¸­
            <code class="language-plaintext highlighter-rouge"
              >passenger_ruby</code
            >
            çš„è·¯å¾„å¯ä»¥é€šè¿‡
            <code class="language-plaintext highlighter-rouge"
              >passenger-config about ruby-command</code
            >
            å‘½ä»¤è·çŸ¥ï¼Œ<code class="language-plaintext highlighter-rouge"
              >passenger_app_root</code
            >
            é»˜è®¤æ˜¯è™šæ‹Ÿä¸»æœº
            <code class="language-plaintext highlighter-rouge">root</code>
            çš„ä¸Šçº§ç›®å½•ï¼š
          </p>

          <div class="language-nginx highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">sample-app.example.com</span><span class="p">;</span>
    <span class="kn">root</span> <span class="n">/srv/sample-app/public</span><span class="p">;</span>
    <span class="kn">passenger_enabled</span> <span class="no">on</span><span class="p">;</span>
    <span class="kn">passenger_ruby</span> <span class="n">/usr/local/rvm/gems/ruby-X.X.X/wrappers/ruby</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
            </div>
          </div>

          <p>
            <code class="language-plaintext highlighter-rouge"
              >/etc/nginx/nginx.conf</code
            >
            é‡Œé»˜è®¤æœ‰ä¸€è¡Œ
            <code class="language-plaintext highlighter-rouge"
              >include /etc/nginx/conf.d/*.conf;</code
            >
            æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å»æ›´æ”¹å…¶ä»–é…ç½®ã€‚äºæ˜¯ç°åœ¨å¯ä»¥æ­£å¼å¯åŠ¨ Nginx äº†ï¼š
          </p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span>systemctl start nginx
<span class="nv">$ </span>systemctl <span class="nb">enable </span>nginx
</code></pre>
            </div>
          </div>

          <p>ç†è®ºä¸Š app å·²ç»éƒ¨ç½²æˆåŠŸäº†ï½ ğŸ‰</p>

          <p>
            ä¹‹åå¦‚æœéœ€è¦è®© Passenger é‡å¯ appï¼Œæˆ–æ˜¯æ›´æ”¹äº†é…ç½®éœ€è¦é‡è½½ Nginxï¼š
          </p>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span><span class="nb">touch</span> /srv/sample-app/tmp/restart.txt
<span class="nv">$ </span>systemctl reload nginx
</code></pre>
            </div>
          </div>

          <h2 id="å¸¸è§é—®é¢˜">å¸¸è§é—®é¢˜</h2>

          <ul>
            <li>
              å¦‚æœåœ¨æœ¬åœ°æµ‹è¯•<strong>ç”Ÿäº§ç¯å¢ƒ</strong>æ—¶ï¼Œå‘ç°é™æ€æ–‡ä»¶æœªèƒ½åŠ è½½ï¼š
              <ul>
                <li>
                  å…¶ä¸€å¯èƒ½æ˜¯å› ä¸ºæ²¡æœ‰åšé¢„ç¼–è¯‘ï¼ŒRails
                  è®¤ä¸ºç”Ÿäº§ç¯å¢ƒçš„é™æ€èµ„æºåº”è¯¥å·²ç»äº‹å…ˆç¼–è¯‘å¥½äº†ï¼Œæ‰€ä»¥ Asset
                  Pipeline çš„å®æ—¶ç¼–è¯‘æ˜¯å…³é—­çš„ï¼›
                </li>
                <li>
                  å…¶äºŒå¯èƒ½æ˜¯å› ä¸º Rails é»˜è®¤æ²¡æœ‰å¯ç”¨é™æ€æ–‡ä»¶æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®
                  <code class="language-plaintext highlighter-rouge"
                    >RAILS_SERVE_STATIC_FILES</code
                  >
                  ç¯å¢ƒå˜é‡æ¥å¼€å¯å®ƒï¼Œä½†è¿™åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½æ•ˆä¸”ä¸å®‰å…¨ï¼Œåº”è¯¥è®© Nginx /
                  Apache æ¥å¤„ç†å®ƒä»¬ã€‚
                </li>
                <li>
                  ä¸Šè¿°é»˜è®¤é…ç½®å‡åœ¨
                  <code class="language-plaintext highlighter-rouge"
                    >config/environments/production.rb</code
                  >
                  æ–‡ä»¶ä¸­ï¼š
                </li>
              </ul>
            </li>
          </ul>

          <div class="language-ruby highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="c1"># Do not fallback to assets pipeline if a precompiled asset is missed.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compile</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># Disable serving static files from the `/public` folder by default since Apache or NGINX already handles this.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">serve_static_files</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'RAILS_SERVE_STATIC_FILES'</span><span class="p">].</span><span class="nf">present?</span>
</code></pre>
            </div>
          </div>

          <ul>
            <li>
              è®¿é—®ç½‘ç«™æ—¶æ˜¾ç¤ºã€ŒIncomplete response received from
              applicationã€ä¸€èˆ¬æ˜¯æ²¡æœ‰è®¾ç½®
              <code class="language-plaintext highlighter-rouge"
                >secret_key_base</code
              >ï¼Œå…·ä½“å‚è§å‰æ–‡ã€Œ<a href="#éƒ¨ç½²-rails">éƒ¨ç½² Rails</a>ã€ã€‚
            </li>
            <li>
              å¦‚æœåœ¨
              <code class="language-plaintext highlighter-rouge"
                >gem install pg</code
              >
              æ—¶æŠ¥å‘Šæ‰¾ä¸åˆ°å¤´æ–‡ä»¶
              <code class="language-plaintext highlighter-rouge"
                >libpq-fe.h</code
              >ï¼Œé‚£æ˜¯å› ä¸ºæ²¡æœ‰
              <code class="language-plaintext highlighter-rouge"
                >yum install postgresql-devel</code
              >ï¼Œæˆ–è€…åœ¨ Debian ç³»çš„ APT ä¸­è¿™ä¸ªåŒ…å«
              <code class="language-plaintext highlighter-rouge">libpq-dev</code
              >ã€‚
            </li>
            <li>
              å¦‚æœåœ¨
              <code class="language-plaintext highlighter-rouge"
                >rake assets:precompile</code
              >
              æ—¶æ˜¾ç¤ºã€ŒKilledã€ï¼Œå¾ˆå¯èƒ½æ˜¯å†…å­˜ä¸è¶³å¯¼è‡´çš„ã€‚æœ€ç®€å•çš„è§£å†³æ–¹æ³•å°±æ˜¯èŠ±é’±ğŸ’°å»å‡çº§
              VPS çš„å†…å­˜ï¼Œæˆ–è€…å¯ä»¥åˆ›å»º SWAP æ–‡ä»¶ç”¨äºè™šæ‹Ÿå†…å­˜ï¼š
            </li>
          </ul>

          <div class="language-sh highlighter-rouge">
            <div class="highlight">
              <pre
                class="highlight"
              ><code><span class="nv">$ </span>fallocate <span class="nt">-l</span> 1G /swapfile
<span class="nv">$ </span><span class="nb">chmod </span>600 /swapfile
<span class="nv">$ </span>mkswap /swapfile
<span class="nv">$ </span>swapon /swapfile
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"/swapfile swap swap defaults 0 0"</span> <span class="o">&gt;&gt;</span> /etc/fstab
</code></pre>
            </div>
          </div>

          <ul>
            <li>
              Bundler ä¼šå°†æ‰€æœ‰
              <code class="language-plaintext highlighter-rouge"
                >--without</code
              >
              çš„ç»„ä¿å­˜åœ¨
              <code class="language-plaintext highlighter-rouge"
                >.bundle/config</code
              >
              ä¸­ï¼Œå› æ­¤ä¹‹åçš„
              <code class="language-plaintext highlighter-rouge"
                >bundle install</code
              >
              æ°¸è¿œä¸ä¼šåŒ…å«è¿™äº›ç»„ã€‚å¦‚æœè¢«è¿™ä¸ªç‰¹æ€§æ‰€å›°æ‰°ï¼Œå¯ä»¥é€šè¿‡åˆ é™¤é…ç½®æ–‡ä»¶ç›¸å…³å†…å®¹æˆ–ä½¿ç”¨
              <code class="language-plaintext highlighter-rouge">--with</code>
              é€‰é¡¹æ¥è§£å†³ã€‚
            </li>
          </ul>

          <h2 id="æµ‹è¯•ç¯å¢ƒ">æµ‹è¯•ç¯å¢ƒ</h2>

          <p>
            CentOS 7 x86_64 (1511) / Nginx 1.8.1 / Passenger 5.0.24 / PostgreSQL
            9.2.14 / Bundler 1.11.2 / Rails 4.2.5 / Ruby 2.3.0
          </p>

          <blockquote>
            <p>å‚è€ƒæ–‡æ¡£ï¼š</p>

            <p>
              <a
                href="https://www.phusionpassenger.com/library/walkthroughs/deploy/ruby/"
                >Deploying a Ruby app with Passenger to production - Passenger
                Library</a
              ><br />
              <a
                href="https://www.phusionpassenger.com/library/config/nginx/reference/"
                >Configuration reference for Nginx - Passenger Library</a
              ><br />
              <a
                href="https://www.nginx.com/resources/admin-guide/nginx-web-server/"
                >Configuring NGINX Plus as a Web Server | NGINX Admin Guide</a
              ><br />
              <a
                href="http://www.postgresql.org/docs/current/interactive/tutorial.html"
                >PostgreSQL Documentation: Tutorial</a
              ><br />
              <a href="http://guides.rubyonrails.org/configuring.html"
                >Configuring Rails Applications - Ruby on Rails Guides</a
              ><br />
              <a href="http://guides.rubyonrails.org/security.html"
                >Ruby on Rails Security Guide - Ruby on Rails Guides</a
              ><br />
              <a
                href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Storage_Administration_Guide/ch-swapspace.html"
                >ChapterÂ 14.Â Swap Space - Storage Administration Guide - Red Hat
                Enterprise Linux 7</a
              >
            </p>
          </blockquote>
        </div>

        <div class="comments">
          <div id="disqus_thread"></div>
          <script>
            var disqus_config = function () {
              this.page.url = "https://blog.yzsun.me/rails-deployment/";
              this.page.identifier = "/rails-deployment/";
            };
            (function () {
              var d = document,
                s = d.createElement("script");
              s.src = "//yzyzsun.disqus.com/embed.js";
              s.setAttribute("data-timestamp", +new Date());
              (d.head || d.body).appendChild(s);
            })();
          </script>
          <noscript
            >Please enable JavaScript to view the
            <a href="https://disqus.com/?ref_noscript"
              >comments powered by Disqus.</a
            ></noscript
          >
        </div>
      </article>
    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          <a href="https://github.com/yzyzsun"
            ><i class="svg-icon github"></i
          ></a>

          <a href="/feed.xml"><i class="svg-icon rss"></i></a>
        </footer>
      </div>
    </div>

    <!-- Google Analytics -->
    <script>
      (function (i, s, o, g, r, a, m) {
        i["GoogleAnalyticsObject"] = r;
        (i[r] =
          i[r] ||
          function () {
            (i[r].q = i[r].q || []).push(arguments);
          }),
          (i[r].l = 1 * new Date());
        (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m);
      })(
        window,
        document,
        "script",
        "//www.google-analytics.com/analytics.js",
        "ga"
      );

      ga("create", "UA-65994616-1", "auto");
      ga("send", "pageview", {
        page: "/rails-deployment/",
        title:
          "Deploy Rails with PostgreSQL Using Passenger and Nginx on CentOS",
      });
    </script>
    <!-- End Google Analytics -->
  </body>
</html>
